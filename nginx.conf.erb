# Metabase Nginx Configuration with CSP for Plausible Analytics
daemon off;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Upstream to Metabase application
    upstream metabase {
        server 127.0.0.1:3000;
    }

    server {
        listen <%= ENV['PORT'] %>;
        server_name _;

        # Logging handled by Scalingo
        access_log off;
        error_log stderr;

        # Increase timeouts for long-running Metabase queries
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

        location / {
            proxy_pass http://metabase;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_buffering off;

            # Override Metabase's default CSP to add Plausible support
            # Maintains all existing Metabase CSP rules and adds Plausible to necessary directives
            proxy_hide_header Content-Security-Policy;
            add_header Content-Security-Policy "font-src *; script-src 'self' https://maps.google.com https://accounts.google.com https://plausible.io 'sha256-ZSYgJqvgOEEcwpkGpHB7fKYVqiBkvMiEVITezQz0eIo=' 'sha256-YX4iJw93x5SU0ple+RI+95HNdNBZSA60gR8a5v7HfOA=' 'sha256-SxNB1/NQ1TUHWrwTi7scFI31VsahWQBj54W7KQZQs1Q=' 'sha256-isH538cVBUY8IMlGYGbWtBwr+cGqkc4mN6nLcA7lUjE=' 'sha256-3N2Z+Nu++/yNMVHIl863JigVmt2Nr9gt2doEMJT2Wzk=' 'sha256-YX4iJw93x5SU0ple+RI+95HNdNBZSA60gR8a5v7HfOA=' 'sha256-ZSYgJqvgOEEcwpkGpHB7fKYVqiBkvMiEVITezQz0eIo=' 'unsafe-eval' 'unsafe-hashes'; style-src 'self' 'unsafe-inline' https://accounts.google.com https://plausible.io; manifest-src 'self'; connect-src 'self' https://accounts.google.com metabase.us10.list-manage.com https://plausible.io; img-src * 'self' data:; frame-src 'self' https://www.metabase.com/ https://metabase.com/ youtube.com *.youtube.com youtu.be *.youtu.be loom.com *.loom.com vimeo.com *.vimeo.com docs.google.com calendar.google.com airtable.com *.airtable.com typeform.com *.typeform.com canva.com *.canva.com codepen.io *.codepen.io figma.com *.figma.com grafana.com *.grafana.com miro.com *.miro.com excalidraw.com *.excalidraw.com notion.com *.notion.com atlassian.com *.atlassian.com trello.com *.trello.com asana.com *.asana.com gist.github.com linkedin.com *.linkedin.com twitter.com *.twitter.com x.com *.x.com plausible.io *.plausible.io; default-src 'none'; media-src www.metabase.com; child-src 'self' https://accounts.google.com; frame-ancestors 'none';" always;

            # Additional security headers
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-XSS-Protection "1; mode=block" always;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
